<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ऑनलाइन परीक्षा पोर्टल</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .bottom-nav-item.active svg, .bottom-nav-item.active span { color: #3b82f6; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl relative">

        <!-- ===== LOADING SPINNER ===== -->
        <div id="loading-spinner" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>

        <!-- ===== LOGIN PAGE ===== -->
        <div id="login-page" class="hidden flex-col items-center justify-center h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-6">
            <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
                <div class="flex border-b mb-6">
                    <button id="login-tab" class="flex-1 py-2 text-center font-semibold text-gray-600 focus:outline-none active-tab">Login</button>
                    <button id="signup-tab" class="flex-1 py-2 text-center font-semibold text-gray-600 focus:outline-none">Sign Up</button>
                </div>
                <form id="login-form" class="space-y-4">
                    <input id="login-email" type="email" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input id="login-password" type="password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center h-4"></p>
                </form>
                <form id="signup-form" class="hidden space-y-4">
                    <input id="signup-name" type="text" placeholder="Full Name" class="w-full px-4 py-3 border rounded-lg" required>
                    <input id="signup-email" type="email" placeholder="Email" class="w-full px-4 py-3 border rounded-lg" required>
                    <input id="signup-password" type="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg" required>
                    <div class="flex justify-around">
                        <label class="flex items-center"><input type="radio" name="role" value="student" class="mr-2" checked> Student</label>
                        <label class="flex items-center"><input type="radio" name="role" value="teacher" class="mr-2"> Teacher</label>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Sign Up</button>
                    <p id="signup-error" class="text-red-500 text-sm text-center h-4"></p>
                </form>
            </div>
        </div>

        <!-- ===== STUDENT DASHBOARD ===== -->
        <div id="student-dashboard" class="hidden flex-col h-screen">
            <header class="flex items-center justify-between p-4 bg-white shadow-md">
                <h1 class="text-xl font-bold text-gray-800">Student Dashboard</h1>
                <div class="relative cursor-pointer" id="notification-bell">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    <span id="notification-dot" class="hidden absolute top-0 right-0 block h-3 w-3 rounded-full bg-red-500 border-2 border-white"></span>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <div id="student-home-content">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Aapki Progress</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6"><canvas id="progressChart"></canvas></div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Live Tests</h2>
                    <div id="student-courses-list" class="space-y-4"></div>
                </div>
                <div id="student-notice-content" class="hidden">
                     <h2 class="text-lg font-semibold text-gray-700 mb-4">Notice Board</h2>
                     <div id="notice-board-list" class="space-y-3"></div>
                </div>
                <div id="student-account-content" class="hidden text-center">
                    <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=User" class="mx-auto rounded-full mb-4" alt="User Avatar">
                    <h2 id="student-name" class="text-xl font-bold"></h2>
                    <p id="student-email" class="text-gray-500"></p>
                    <button class="mt-8 w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600" id="logout-btn-student">Logout</button>
                </div>
            </main>
            <footer class="flex justify-around p-2 bg-white border-t">
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2 active" onclick="showStudentContent('home')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8z"/></svg><span class="text-xs mt-1">Home</span></button>
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2" onclick="showStudentContent('notice')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-2 16H8v-2h4v2zm0-4H8v-2h4v2zm4-4H8V8h8v2z"/></svg><span class="text-xs mt-1">Notice</span></button>
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2" onclick="showStudentContent('account')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3s1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22c.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span class="text-xs mt-1">Account</span></button>
            </footer>
        </div>

        <!-- ===== TEACHER DASHBOARD ===== -->
        <div id="teacher-dashboard" class="hidden flex-col h-screen">
            <header class="flex items-center justify-between p-4 bg-indigo-600 text-white shadow-lg">
                <h1 class="text-xl font-bold">Teacher Dashboard</h1>
                <button class="focus:outline-none" id="logout-btn-teacher"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">Create New Test</h3>
                    <input id="test-name-input" type="text" placeholder="Test Name" class="w-full p-2 border rounded-lg mb-2">
                    <input id="test-duration-input" type="number" placeholder="Duration (minutes)" class="w-full p-2 border rounded-lg mb-2">
                    <button id="create-test-btn" class="w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">Create Test</button>
                </div>
                <div id="manage-tests-section" class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">Manage Tests</h3>
                    <div id="teacher-tests-list" class="space-y-3"></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800">Send Notice</h3>
                    <textarea id="notice-input" class="w-full mt-2 p-2 border rounded-lg h-24" placeholder="Notice yahan likhein..."></textarea>
                    <button id="send-notice-btn" class="mt-2 w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">Bhejein</button>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                     <h3 class="font-bold text-gray-800">Send Notification</h3>
                    <textarea id="notification-input" class="w-full mt-2 p-2 border rounded-lg h-24" placeholder="Notification yahan likhein..."></textarea>
                    <button id="send-notification-btn" class="mt-2 w-full bg-purple-500 text-white font-semibold py-2 rounded-lg hover:bg-purple-600">Bhejein</button>
                </div>
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Student Progress Tracking</h2>
                <div id="student-progress-list" class="bg-white p-4 rounded-xl shadow-md space-y-4"></div>
            </main>
        </div>

        <!-- ===== TEST PAGE (STUDENT) ===== -->
        <div id="test-page" class="hidden flex-col h-screen p-4">
            <header class="flex items-center justify-between pb-4 border-b">
                <h1 id="test-page-title" class="text-xl font-bold">Test</h1>
                <div id="test-timer" class="text-lg font-bold text-red-500"></div>
            </header>
            <main class="flex-grow py-4">
                <div id="question-container">
                    <h2 id="question-text" class="text-lg font-semibold mb-4"></h2>
                    <div id="options-container" class="space-y-3"></div>
                </div>
            </main>
            <footer class="flex justify-between pt-4 border-t">
                <button id="prev-question-btn" class="px-6 py-2 bg-gray-300 rounded-lg">Previous</button>
                <button id="next-question-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg">Next</button>
                <button id="submit-test-btn" class="hidden px-6 py-2 bg-green-500 text-white rounded-lg">Submit Test</button>
            </footer>
        </div>
        
        <!-- MODALS -->
        <div id="notification-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-50 p-6"><h3 class="text-lg font-bold mb-4">Notifications</h3><div id="notification-list" class="space-y-3 max-h-64 overflow-y-auto"></div><button id="close-notification-modal" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg">Close</button></div>
        </div>
        <div id="add-question-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-50 p-6">
                <h3 class="text-lg font-bold mb-4">Add Question to Test</h3>
                <form id="add-question-form">
                    <textarea id="question-input" placeholder="Enter question" class="w-full p-2 border rounded-lg mb-2" required></textarea>
                    <input id="option1-input" type="text" placeholder="Option 1" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option2-input" type="text" placeholder="Option 2" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option3-input" type="text" placeholder="Option 3" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option4-input" type="text" placeholder="Option 4" class="w-full p-2 border rounded-lg mb-2" required>
                    <select id="correct-answer-select" class="w-full p-2 border rounded-lg mb-4" required>
                        <option value="">Select Correct Answer</option>
                        <option value="0">Option 1</option><option value="1">Option 2</option><option value="2">Option 3</option><option value="3">Option 4</option>
                    </select>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="close-question-modal" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Save Question</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCTywtZz-kOZH1RJKXiEsO8SK4YlLyR3ck",
          authDomain: "csc-campus-test-app.firebaseapp.com",
          projectId: "csc-campus-test-app",
          storageBucket: "csc-campus-test-app.firebasestorage.app",
          messagingSenderId: "798918081054",
          appId: "1:798918081054:web:7587d7e6f83890d13fcc0f"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500">Firebase config error.</p>';
        }

        const AUTHORIZED_TEACHER_EMAIL = "teacher@example.com";
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginPage = document.getElementById('login-page');
        const studentDashboard = document.getElementById('student-dashboard');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const testPage = document.getElementById('test-page');

        const showLoading = (isLoading) => { loadingSpinner.style.display = isLoading ? 'flex' : 'none'; };
        const showPage = (pageElement) => {
            [loginPage, studentDashboard, teacherDashboard, testPage].forEach(p => p.classList.add('hidden'));
            if (pageElement) {
                pageElement.classList.remove('hidden');
                pageElement.classList.add('flex');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.role === 'student') {
                        setupStudentDashboard(userData);
                        showPage(studentDashboard);
                    } else if (userData.role === 'teacher') {
                        setupTeacherDashboard();
                        showPage(teacherDashboard);
                    }
                } else {
                    await signOut(auth);
                }
            } else {
                showPage(loginPage);
            }
            showLoading(false);
        });

        // --- Auth Forms ---
        document.getElementById('login-tab').addEventListener('click', () => {
            document.getElementById('login-tab').classList.add('active-tab');
            document.getElementById('signup-tab').classList.remove('active-tab');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
        });
        document.getElementById('signup-tab').addEventListener('click', () => {
            document.getElementById('signup-tab').classList.add('active-tab');
            document.getElementById('login-tab').classList.remove('active-tab');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
        });
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.textContent = '';
            if (role === 'teacher' && email !== AUTHORIZED_TEACHER_EMAIL) {
                errorEl.textContent = "You are not authorized to register as a teacher.";
                showLoading(false);
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, name, email, role, createdAt: serverTimestamp() });
                if (role === 'student') {
                    await setDoc(doc(db, "studentProgress", user.uid), { scores: [65, 72, 70, 81, 78, 90] });
                }
            } catch (error) {
                errorEl.textContent = error.message;
            } finally {
                showLoading(false);
            }
        });
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = "Failed to login. Check email/password.";
            } finally {
                showLoading(false);
            }
        });
        document.getElementById('logout-btn-student').addEventListener('click', () => signOut(auth));
        document.getElementById('logout-btn-teacher').addEventListener('click', () => signOut(auth));

        // --- Student Dashboard ---
        let progressChartInstance = null;
        async function setupStudentDashboard(userData) {
            document.getElementById('student-name').textContent = userData.name;
            document.getElementById('student-email').textContent = userData.email;
            onSnapshot(doc(db, "studentProgress", userData.uid), (doc) => {
                if (doc.exists()) renderProgressChart(doc.data().scores);
            });
            listenForNotices();
            listenForNotifications();
            listenForLiveTests();
        }
        function renderProgressChart(data) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (progressChartInstance) progressChartInstance.destroy();
            progressChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Test Scores (%)',
                        data: data,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        function listenForNotices() {
            const q = query(collection(db, "notices"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const noticeList = document.getElementById('notice-board-list');
                noticeList.innerHTML = '';
                if(querySnapshot.empty) {
                    noticeList.innerHTML = '<p class="text-gray-500">Abhi koi notice nahi hai.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const notice = doc.data();
                    const date = notice.createdAt?.toDate().toLocaleDateString('en-IN') || 'N/A';
                    noticeList.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-md"><p class="text-sm text-gray-700">${notice.content}</p><p class="text-xs text-gray-400 text-right mt-2">${date}</p></div>`;
                });
            });
        }
        function listenForNotifications() {
            const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = '';
                if(!querySnapshot.empty) {
                    document.getElementById('notification-dot').classList.remove('hidden');
                } else {
                     document.getElementById('notification-dot').classList.add('hidden');
                }
                querySnapshot.forEach((doc) => {
                    const notification = doc.data();
                    const date = notification.createdAt?.toDate().toLocaleDateString('en-IN') || 'N/A';
                    notificationList.innerHTML += `<div class="border-b pb-2"><p class="text-sm text-gray-700">${notification.content}</p><p class="text-xs text-gray-400 text-right mt-1">${date}</p></div>`;
                });
            });
        }
        function listenForLiveTests() {
            const q = query(collection(db, "tests"), where("isLive", "==", true), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                const coursesList = document.getElementById('student-courses-list');
                coursesList.innerHTML = '';
                if(querySnapshot.empty) {
                    coursesList.innerHTML = '<p class="text-gray-500">Abhi koi test live nahi hai.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const test = doc.data();
                    const testEl = document.createElement('div');
                    testEl.className = "bg-white p-4 rounded-xl shadow-md flex items-center justify-between";
                    testEl.innerHTML = `<div><h3 class="font-bold text-gray-800">${test.name}</h3><p class="text-sm text-gray-500">Duration: ${test.duration} mins</p></div><button class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Start Test</button>`;
                    testEl.querySelector('button').onclick = () => startTest(doc.id, test.name, test.duration);
                    coursesList.appendChild(testEl);
                });
            });
        }

        // --- Teacher Dashboard ---
        async function setupTeacherDashboard() {
            document.getElementById('create-test-btn').onclick = async () => {
                const name = document.getElementById('test-name-input').value.trim();
                const duration = document.getElementById('test-duration-input').value.trim();
                if (!name || !duration) {
                    showCustomAlert('Please fill all test fields.', true);
                    return;
                }
                try {
                    await addDoc(collection(db, "tests"), { name, duration: parseInt(duration), isLive: false, createdAt: serverTimestamp() });
                    showCustomAlert('Test created successfully!');
                    document.getElementById('test-name-input').value = '';
                    document.getElementById('test-duration-input').value = '';
                } catch (e) { showCustomAlert('Error creating test.', true); }
            };
            document.getElementById('send-notice-btn').onclick = async () => {
                 const input = document.getElementById('notice-input');
                if (input.value.trim() === '') return;
                try {
                    await addDoc(collection(db, "notices"), { content: input.value, createdAt: serverTimestamp() });
                    input.value = '';
                    showCustomAlert('Notice sent successfully!');
                } catch (error) { showCustomAlert('Failed to send notice.', true); }
            };
            document.getElementById('send-notification-btn').onclick = async () => {
                const input = document.getElementById('notification-input');
                if (input.value.trim() === '') return;
                try {
                    await addDoc(collection(db, "notifications"), { content: input.value, createdAt: serverTimestamp() });
                    input.value = '';
                    showCustomAlert('Notification sent successfully!');
                } catch (error) { showCustomAlert('Failed to send notification.', true); }
            };
            listenForStudentProgress();
            listenForTeacherTests();
        }
        function listenForStudentProgress() {
            const q = query(collection(db, "users"), where("role", "==", "student"));
            onSnapshot(q, (querySnapshot) => {
                const progressList = document.getElementById('student-progress-list');
                progressList.innerHTML = '';
                if(querySnapshot.empty) {
                    progressList.innerHTML = '<p class="text-gray-500">No students found.</p>';
                    return;
                }
                querySnapshot.forEach(async (userDoc) => {
                    const student = userDoc.data();
                    const progressDoc = await getDoc(doc(db, "studentProgress", student.uid));
                    let avgScore = 0;
                    if (progressDoc.exists()) {
                        const scores = progressDoc.data().scores;
                        if(scores && scores.length > 0) {
                           avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                        }
                    }
                    let barColor = 'bg-green-600';
                    if (avgScore < 75) barColor = 'bg-yellow-400';
                    if (avgScore < 50) barColor = 'bg-red-600';
                    const studentElement = document.createElement('div');
                    studentElement.className = 'flex items-center justify-between';
                    studentElement.innerHTML = `<div><p class="font-semibold">${student.name}</p><p class="text-sm text-gray-500">Avg. Score: ${avgScore.toFixed(0)}%</p></div><div class="w-1/2 bg-gray-200 rounded-full h-2.5"><div class="${barColor} h-2.5 rounded-full" style="width: ${avgScore}%"></div></div>`;
                    progressList.appendChild(studentElement);
                });
            });
        }
        function listenForTeacherTests() {
            const q = query(collection(db, "tests"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('teacher-tests-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500">No tests created yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const test = doc.data();
                    const el = document.createElement('div');
                    el.className = 'p-2 border rounded-lg flex justify-between items-center';
                    el.innerHTML = `<span>${test.name} (${test.isLive ? '<span class="text-green-500">Live</span>' : 'Draft'})</span>
                        <div class="space-x-2">
                            <button class="add-questions-btn text-sm bg-yellow-500 text-white px-2 py-1 rounded">Add Questions</button>
                            <button class="go-live-btn text-sm ${test.isLive ? 'bg-red-500' : 'bg-green-500'} text-white px-2 py-1 rounded">${test.isLive ? 'End Test' : 'Go Live'}</button>
                        </div>`;
                    el.querySelector('.add-questions-btn').onclick = () => openAddQuestionModal(doc.id);
                    el.querySelector('.go-live-btn').onclick = () => toggleTestLiveStatus(doc.id, !test.isLive);
                    list.appendChild(el);
                });
            });
        }
        async function toggleTestLiveStatus(testId, newStatus) {
            await updateDoc(doc(db, "tests", testId), { isLive: newStatus });
            showCustomAlert(`Test is now ${newStatus ? 'live' : 'offline'}.`);
        }
        
        // --- Add Question Modal (Teacher) ---
        let currentTestIdForQuestions = null;
        const addQuestionModal = document.getElementById('add-question-modal');
        const addQuestionForm = document.getElementById('add-question-form');
        function openAddQuestionModal(testId) {
            currentTestIdForQuestions = testId;
            addQuestionModal.classList.remove('hidden');
        }
        document.getElementById('close-question-modal').onclick = () => addQuestionModal.classList.add('hidden');
        addQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const question = document.getElementById('question-input').value;
            const options = [
                document.getElementById('option1-input').value,
                document.getElementById('option2-input').value,
                document.getElementById('option3-input').value,
                document.getElementById('option4-input').value,
            ];
            const correctIndex = document.getElementById('correct-answer-select').value;
            
            try {
                const questionRef = collection(db, "tests", currentTestIdForQuestions, "questions");
                await addDoc(questionRef, { question, options, correctIndex: parseInt(correctIndex) });
                
                showCustomAlert('Question added successfully!');
                addQuestionForm.reset();
                addQuestionModal.classList.add('hidden');
            } catch (error) {
                console.error("Error adding question: ", error);
                showCustomAlert('Failed to add question.', true);
            } finally {
                showLoading(false);
            }
        });

        // --- Test Taking Logic (Student) ---
        let testTimerInterval;
        let currentQuestions = [];
        let userAnswers = {};
        let currentQuestionIndex = 0;

        async function startTest(testId, testName, duration) {
            showPage(testPage);
            document.getElementById('test-page-title').textContent = testName;

            const q = query(collection(db, "tests", testId, "questions"));
            const snapshot = await getDocs(q);
            currentQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            userAnswers = {};
            currentQuestionIndex = 0;

            if (currentQuestions.length > 0) {
                displayQuestion(currentQuestionIndex);
            } else {
                document.getElementById('question-container').innerHTML = '<p>This test has no questions yet.</p>';
            }

            startTimer(duration);
        }

        function displayQuestion(index) {
            const question = currentQuestions[index];
            document.getElementById('question-text').textContent = `${index + 1}. ${question.question}`;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            question.options.forEach((option, i) => {
                const optionId = `q${index}_option${i}`;
                const isChecked = userAnswers[index] === i;
                optionsContainer.innerHTML += `
                    <label for="${optionId}" class="block p-3 border rounded-lg hover:bg-gray-100 cursor-pointer">
                        <input type="radio" id="${optionId}" name="question${index}" value="${i}" ${isChecked ? 'checked' : ''}>
                        <span class="ml-2">${option}</span>
                    </label>`;
            });
            
            optionsContainer.onchange = (e) => {
                userAnswers[index] = parseInt(e.target.value);
            };

            document.getElementById('prev-question-btn').style.visibility = index === 0 ? 'hidden' : 'visible';
            document.getElementById('next-question-btn').style.display = index === currentQuestions.length - 1 ? 'none' : 'block';
            document.getElementById('submit-test-btn').style.display = index === currentQuestions.length - 1 ? 'block' : 'none';
        }

        document.getElementById('next-question-btn').onclick = () => {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            }
        };
        document.getElementById('prev-question-btn').onclick = () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
            }
        };
        document.getElementById('submit-test-btn').onclick = () => {
            submitTest();
        };

        function startTimer(duration) {
            let timeLeft = duration * 60;
            const timerEl = document.getElementById('test-timer');
            clearInterval(testTimerInterval);
            testTimerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                timerEl.textContent = `${minutes}:${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(testTimerInterval);
                    submitTest();
                }
                timeLeft--;
            }, 1000);
        }

        function submitTest() {
            clearInterval(testTimerInterval);
            let score = 0;
            for (let i = 0; i < currentQuestions.length; i++) {
                if (userAnswers[i] === currentQuestions[i].correctIndex) {
                    score++;
                }
            }
            const percentage = (score / currentQuestions.length) * 100;
            showCustomAlert(`Test Submitted! Your score: ${percentage.toFixed(2)}%`);
            showPage(studentDashboard);
        }

        // --- General UI Functions ---
        function showStudentContent(contentId) {
            document.querySelectorAll('#student-dashboard main > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(`student-${contentId}-content`).classList.remove('hidden');
            document.querySelectorAll('.bottom-nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.bottom-nav-item[onclick="showStudentContent('${contentId}')"]`).classList.add('active');
        }
        window.showStudentContent = showStudentContent;
        const notificationModal = document.getElementById('notification-modal');
        document.getElementById('notification-bell').addEventListener('click', () => {
            notificationModal.classList.remove('hidden');
            document.getElementById('notification-dot').classList.add('hidden');
        });
        document.getElementById('close-notification-modal').addEventListener('click', () => notificationModal.classList.add('hidden'));
        document.querySelector('.modal-backdrop').addEventListener('click', () => notificationModal.classList.add('hidden'));
        function showCustomAlert(message, isError = false) {
            const alertBox = document.createElement('div');
            alertBox.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'} z-50`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

    </script>
</body>
</ht
