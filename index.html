<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ऑनलाइन परीक्षा पोर्टल</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .bottom-nav-item.active svg, .bottom-nav-item.active span { color: #3b82f6; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl relative">

        <!-- ===== LOADING SPINNER ===== -->
        <div id="loading-spinner" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        </div>

        <!-- ===== LOGIN PAGE ===== -->
        <div id="login-page" class="hidden flex-col items-center justify-center h-screen bg-gradient-to-br from-blue-500 to-indigo-600 p-6">
            <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
                <div class="flex border-b mb-6">
                    <button id="login-tab" class="flex-1 py-2 text-center font-semibold text-gray-600 focus:outline-none active-tab">Login</button>
                    <button id="signup-tab" class="flex-1 py-2 text-center font-semibold text-gray-600 focus:outline-none">Sign Up</button>
                </div>
                <form id="login-form" class="space-y-4">
                    <input id="login-email" type="email" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                    <input id="login-password" type="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg" required>
                    <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center h-4"></p>
                </form>
                <form id="signup-form" class="hidden space-y-4">
                    <input id="signup-name" type="text" placeholder="Full Name" class="w-full px-4 py-3 border rounded-lg" required>
                    <input id="signup-email" type="email" placeholder="Email" class="w-full px-4 py-3 border rounded-lg" required>
                    <input id="signup-password" type="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg" required>
                    <div class="flex justify-around">
                        <label class="flex items-center"><input type="radio" name="role" value="student" class="mr-2" checked> Student</label>
                        <label class="flex items-center"><input type="radio" name="role" value="teacher" class="mr-2"> Teacher</label>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Sign Up</button>
                    <p id="signup-error" class="text-red-500 text-sm text-center h-4"></p>
                </form>
            </div>
        </div>

        <!-- ===== STUDENT DASHBOARD ===== -->
        <div id="student-dashboard" class="hidden flex-col h-screen">
            <header class="flex items-center justify-between p-4 bg-white shadow-md">
                <h1 class="text-xl font-bold text-gray-800">Student Dashboard</h1>
                <div class="relative cursor-pointer" id="notification-bell">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    <span id="notification-dot" class="hidden absolute top-0 right-0 block h-3 w-3 rounded-full bg-red-500 border-2 border-white"></span>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <div id="student-home-content">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Aapki Progress</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md mb-6"><canvas id="progressChart"></canvas></div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Available Tests</h2>
                    <div id="student-courses-list" class="space-y-4"></div>
                </div>
                <div id="student-results-content" class="hidden">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">My Results</h2>
                    <div id="student-results-list" class="space-y-3"></div>
                </div>
                <div id="student-notice-content" class="hidden">
                     <h2 class="text-lg font-semibold text-gray-700 mb-4">Notice Board</h2>
                     <div id="notice-board-list" class="space-y-3"></div>
                </div>
                <div id="student-account-content" class="hidden text-center">
                    <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=User" class="mx-auto rounded-full mb-4" alt="User Avatar">
                    <h2 id="student-name" class="text-xl font-bold"></h2>
                    <p id="student-email" class="text-gray-500"></p>
                    <button class="mt-8 w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600" id="logout-btn-student">Logout</button>
                </div>
            </main>
            <footer class="flex justify-around p-2 bg-white border-t">
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2 active" onclick="showStudentContent('home')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8z"/></svg><span class="text-xs mt-1">Home</span></button>
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2" onclick="showStudentContent('results')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M9 11.24V8h6v3.24l-3 1.74l-3-1.74zM12 1L3 5v6c0 5.55 3.84 10.74 9 12c5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg><span class="text-xs mt-1">Results</span></button>
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2" onclick="showStudentContent('notice')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-2 16H8v-2h4v2zm0-4H8v-2h4v2zm4-4H8V8h8v2z"/></svg><span class="text-xs mt-1">Notice</span></button>
                <button class="bottom-nav-item flex flex-col items-center text-gray-500 w-1/4 p-2" onclick="showStudentContent('account')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3s1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22c.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span class="text-xs mt-1">Account</span></button>
            </footer>
        </div>

        <!-- ===== TEACHER DASHBOARD ===== -->
        <div id="teacher-dashboard" class="hidden flex-col h-screen">
            <header class="flex items-center justify-between p-4 bg-indigo-600 text-white shadow-lg">
                <h1 class="text-xl font-bold">Teacher Dashboard</h1>
                <button class="focus:outline-none" id="logout-btn-teacher"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">Create New Test</h3>
                    <input id="test-name-input" type="text" placeholder="Test Name" class="w-full p-2 border rounded-lg mb-2">
                    <input id="test-duration-input" type="number" placeholder="Duration (minutes)" class="w-full p-2 border rounded-lg mb-2">
                    <label class="block text-sm font-medium text-gray-700">Start Time</label>
                    <input id="test-start-time" type="datetime-local" class="w-full p-2 border rounded-lg mb-2">
                    <label class="block text-sm font-medium text-gray-700">End Time</label>
                    <input id="test-end-time" type="datetime-local" class="w-full p-2 border rounded-lg mb-2">
                    <button id="create-test-btn" class="w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">Create Test</button>
                </div>
                <div id="manage-tests-section" class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">Manage Tests</h3>
                    <div id="teacher-tests-list" class="space-y-3"></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <h3 class="font-bold text-gray-800">Send Notice</h3>
                    <textarea id="notice-input" class="w-full mt-2 p-2 border rounded-lg h-24" placeholder="Notice yahan likhein..."></textarea>
                    <button id="send-notice-btn" class="mt-2 w-full bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600">Bhejein</button>
                </div>
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Student Progress Tracking</h2>
                <div id="student-progress-list" class="bg-white p-4 rounded-xl shadow-md space-y-4"></div>
            </main>
        </div>

        <!-- ===== TEST PAGE (STUDENT) ===== -->
        <div id="test-page" class="hidden flex-col h-screen p-4">
            <header class="flex items-center justify-between pb-4 border-b">
                <h1 id="test-page-title" class="text-xl font-bold">Test</h1>
                <div id="test-timer" class="text-lg font-bold text-red-500"></div>
            </header>
            <main class="flex-grow py-4">
                <div id="question-container">
                    <h2 id="question-text" class="text-lg font-semibold mb-4"></h2>
                    <div id="options-container" class="space-y-3"></div>
                </div>
            </main>
            <footer class="flex justify-between pt-4 border-t">
                <button id="prev-question-btn" class="px-6 py-2 bg-gray-300 rounded-lg">Previous</button>
                <button id="next-question-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg">Next</button>
                <button id="submit-test-btn" class="hidden px-6 py-2 bg-green-500 text-white rounded-lg">Submit Test</button>
            </footer>
        </div>
        
        <!-- MODALS -->
        <div id="notification-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-50 p-6"><h3 class="text-lg font-bold mb-4">Notifications</h3><div id="notification-list" class="space-y-3 max-h-64 overflow-y-auto"></div><button id="close-notification-modal" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg">Close</button></div>
        </div>
        <div id="add-question-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-50 p-6">
                <h3 class="text-lg font-bold mb-4">Add Question to Test</h3>
                <form id="add-question-form">
                    <textarea id="question-input" placeholder="Enter question" class="w-full p-2 border rounded-lg mb-2" required></textarea>
                    <input id="option1-input" type="text" placeholder="Option 1" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option2-input" type="text" placeholder="Option 2" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option3-input" type="text" placeholder="Option 3" class="w-full p-2 border rounded-lg mb-2" required>
                    <input id="option4-input" type="text" placeholder="Option 4" class="w-full p-2 border rounded-lg mb-2" required>
                    <select id="correct-answer-select" class="w-full p-2 border rounded-lg mb-4" required>
                        <option value="">Select Correct Answer</option>
                        <option value="0">Option 1</option><option value="1">Option 2</option><option value="2">Option 3</option><option value="3">Option 4</option>
                    </select>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="close-question-modal" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Save Question</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="view-results-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center p-4">
            <div class="modal-backdrop fixed inset-0"></div>
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md z-50 p-6">
                <h3 id="results-modal-title" class="text-lg font-bold mb-4">Student Results</h3>
                <div id="results-modal-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                <button id="close-results-modal" class="mt-4 w-full bg-gray-200 text-gray-700 font-bold py-2 rounded-lg">Close</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy, updateDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCTywtZz-kOZH1RJKXiEsO8SK4YlLyR3ck",
          authDomain: "csc-campus-test-app.firebaseapp.com",
          projectId: "csc-campus-test-app",
          storageBucket: "csc-campus-test-app.firebasestorage.app",
          messagingSenderId: "798918081054",
          appId: "1:798918081054:web:7587d7e6f83890d13fcc0f"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500">Firebase config error.</p>';
        }

        const AUTHORIZED_TEACHER_EMAIL = "teacher@example.com";
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginPage = document.getElementById('login-page');
        const studentDashboard = document.getElementById('student-dashboard');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const testPage = document.getElementById('test-page');
        let currentUser = null;

        const showLoading = (isLoading) => { loadingSpinner.style.display = isLoading ? 'flex' : 'none'; };
        const showPage = (pageElement) => {
            [loginPage, studentDashboard, teacherDashboard, testPage].forEach(p => p.classList.add('hidden'));
            if (pageElement) {
                pageElement.classList.remove('hidden');
                pageElement.classList.add('flex');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.role === 'student') {
                        setupStudentDashboard(userData);
                        showPage(studentDashboard);
                    } else if (userData.role === 'teacher') {
                        setupTeacherDashboard();
                        showPage(teacherDashboard);
                    }
                } else { await signOut(auth); }
            } else { showPage(loginPage); }
            showLoading(false);
        });

        // --- Auth Forms ---
        document.getElementById('login-tab').addEventListener('click', () => { /* ... */ });
        document.getElementById('signup-tab').addEventListener('click', () => { /* ... */ });
        document.getElementById('signup-form').addEventListener('submit', async (e) => { /* ... */ });
        document.getElementById('login-form').addEventListener('submit', async (e) => { /* ... */ });
        document.getElementById('logout-btn-student').addEventListener('click', () => signOut(auth));
        document.getElementById('logout-btn-teacher').addEventListener('click', () => signOut(auth));

        // --- Student Dashboard ---
        let progressChartInstance = null;
        async function setupStudentDashboard(userData) {
            document.getElementById('student-name').textContent = userData.name;
            document.getElementById('student-email').textContent = userData.email;
            onSnapshot(doc(db, "studentProgress", userData.uid), (doc) => {
                if (doc.exists()) renderProgressChart(doc.data().scores);
            });
            listenForNotices();
            listenForNotifications();
            listenForLiveTests();
            listenForStudentResults(userData.uid);
        }
        function renderProgressChart(data) { /* ... */ }
        function listenForNotices() { /* ... */ }
        function listenForNotifications() { /* ... */ }
        function listenForLiveTests() {
            const now = Timestamp.now();
            const q = query(collection(db, "tests"), where("endTime", ">", now));
            onSnapshot(q, (querySnapshot) => {
                const coursesList = document.getElementById('student-courses-list');
                coursesList.innerHTML = '';
                let testsAvailable = false;
                querySnapshot.forEach((doc) => {
                    const test = doc.data();
                    if (test.startTime.toMillis() <= now.toMillis()) {
                        testsAvailable = true;
                        const testEl = document.createElement('div');
                        testEl.className = "bg-white p-4 rounded-xl shadow-md flex items-center justify-between";
                        testEl.innerHTML = `<div><h3 class="font-bold text-gray-800">${test.name}</h3><p class="text-sm text-gray-500">Ends: ${test.endTime.toDate().toLocaleString()}</p></div><button class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Start Test</button>`;
                        testEl.querySelector('button').onclick = () => startTest(doc.id, test.name, test.duration);
                        coursesList.appendChild(testEl);
                    }
                });
                if(!testsAvailable) {
                    coursesList.innerHTML = '<p class="text-gray-500">Abhi koi test live nahi hai.</p>';
                }
            });
        }
        function listenForStudentResults(studentId) {
            const q = query(collection(db, "results"), where("studentId", "==", studentId), orderBy("submittedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('student-results-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-gray-500">You have not attempted any tests yet.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const result = doc.data();
                    list.innerHTML += `<div class="bg-white p-4 rounded-xl shadow-md"><h3 class="font-bold">${result.testName}</h3><p>Score: ${result.score}/${result.totalQuestions} (${result.percentage.toFixed(2)}%)</p><p class="text-xs text-gray-400 mt-1">Submitted: ${result.submittedAt.toDate().toLocaleString()}</p></div>`;
                });
            });
        }

        // --- Teacher Dashboard ---
        async function setupTeacherDashboard() {
            document.getElementById('create-test-btn').onclick = async () => {
                const name = document.getElementById('test-name-input').value.trim();
                const duration = document.getElementById('test-duration-input').value.trim();
                const startTime = document.getElementById('test-start-time').value;
                const endTime = document.getElementById('test-end-time').value;
                if (!name || !duration || !startTime || !endTime) {
                    showCustomAlert('Please fill all test fields.', true);
                    return;
                }
                try {
                    await addDoc(collection(db, "tests"), { 
                        name, 
                        duration: parseInt(duration), 
                        startTime: Timestamp.fromDate(new Date(startTime)),
                        endTime: Timestamp.fromDate(new Date(endTime)),
                        isLive: false, // This can be removed or kept for manual override
                        createdAt: serverTimestamp() 
                    });
                    showCustomAlert('Test created successfully!');
                    document.getElementById('test-name-input').value = '';
                    document.getElementById('test-duration-input').value = '';
                    document.getElementById('test-start-time').value = '';
                    document.getElementById('test-end-time').value = '';
                } catch (e) { showCustomAlert('Error creating test.', true); console.error(e) }
            };
            document.getElementById('send-notice-btn').onclick = async () => { /* ... */ };
            listenForStudentProgress();
            listenForTeacherTests();
        }
        function listenForStudentProgress() {
            const q = query(collection(db, "users"), where("role", "==", "student"));
            onSnapshot(q, (querySnapshot) => {
                const progressList = document.getElementById('student-progress-list');
                progressList.innerHTML = '';
                if(querySnapshot.empty) {
                    progressList.innerHTML = '<p class="text-gray-500">No students found.</p>';
                    return;
                }
                querySnapshot.forEach(async (userDoc) => {
                    const student = userDoc.data();
                    const studentElement = document.createElement('div');
                    studentElement.className = 'flex items-center justify-between';
                    studentElement.innerHTML = `<div><p class="font-semibold">${student.name}</p></div><button class="view-results-btn text-sm bg-blue-500 text-white px-2 py-1 rounded">View Results</button>`;
                    studentElement.querySelector('.view-results-btn').onclick = () => openResultsModal(student.uid, student.name);
                    progressList.appendChild(studentElement);
                });
            });
        }
        function listenForTeacherTests() { /* ... (no changes) ... */ }
        async function toggleTestLiveStatus(testId, newStatus) { /* ... (no changes) ... */ }
        
        // --- Add Question Modal (Teacher) ---
        let currentTestIdForQuestions = null;
        const addQuestionModal = document.getElementById('add-question-modal');
        const addQuestionForm = document.getElementById('add-question-form');
        function openAddQuestionModal(testId) { /* ... */ }
        document.getElementById('close-question-modal').onclick = () => addQuestionModal.classList.add('hidden');
        addQuestionForm.addEventListener('submit', async (e) => { /* ... */ });

        // --- Test Taking Logic (Student) ---
        let testTimerInterval;
        let currentQuestions = [];
        let userAnswers = {};
        let currentQuestionIndex = 0;
        let currentTestId = null;

        async function startTest(testId, testName, duration) {
            currentTestId = testId;
            showPage(testPage);
            document.getElementById('test-page-title').textContent = testName;
            const q = query(collection(db, "tests", testId, "questions"));
            const snapshot = await getDocs(q);
            currentQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            userAnswers = {};
            currentQuestionIndex = 0;
            if (currentQuestions.length > 0) { displayQuestion(0); } 
            else { document.getElementById('question-container').innerHTML = '<p>This test has no questions yet.</p>'; }
            startTimer(duration);
        }
        function displayQuestion(index) { /* ... */ }
        document.getElementById('next-question-btn').onclick = () => { /* ... */ };
        document.getElementById('prev-question-btn').onclick = () => { /* ... */ };
        document.getElementById('submit-test-btn').onclick = () => { submitTest(); };
        function startTimer(duration) { /* ... */ }
        async function submitTest() {
            clearInterval(testTimerInterval);
            let score = 0;
            for (let i = 0; i < currentQuestions.length; i++) {
                if (userAnswers[i] === currentQuestions[i].correctIndex) {
                    score++;
                }
            }
            const percentage = currentQuestions.length > 0 ? (score / currentQuestions.length) * 100 : 0;
            
            try {
                await addDoc(collection(db, "results"), {
                    studentId: currentUser.uid,
                    testId: currentTestId,
                    testName: document.getElementById('test-page-title').textContent,
                    score: score,
                    totalQuestions: currentQuestions.length,
                    percentage: percentage,
                    submittedAt: serverTimestamp()
                });
                showCustomAlert(`Test Submitted! Your score: ${percentage.toFixed(2)}%`);
            } catch (e) {
                showCustomAlert('Error submitting result.', true);
                console.error(e);
            }
            showPage(studentDashboard);
        }

        // --- Results Modal (Teacher) ---
        const resultsModal = document.getElementById('view-results-modal');
        function openResultsModal(studentId, studentName) {
            document.getElementById('results-modal-title').textContent = `${studentName}'s Results`;
            const list = document.getElementById('results-modal-list');
            list.innerHTML = '<p>Loading results...</p>';
            resultsModal.classList.remove('hidden');

            const q = query(collection(db, "results"), where("studentId", "==", studentId), orderBy("submittedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = '<p>No results found for this student.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const result = doc.data();
                    list.innerHTML += `<div class="border-b pb-2"><h4 class="font-semibold">${result.testName}</h4><p>Score: ${result.score}/${result.totalQuestions} (${result.percentage.toFixed(2)}%)</p><p class="text-xs text-gray-400 mt-1">Submitted: ${result.submittedAt.toDate().toLocaleString()}</p></div>`;
                });
            });
        }
        document.getElementById('close-results-modal').onclick = () => resultsModal.classList.add('hidden');

        // --- General UI Functions ---
        function showStudentContent(contentId) {
            ['home', 'results', 'notice', 'account'].forEach(id => document.getElementById(`student-${id}-content`).classList.add('hidden'));
            document.getElementById(`student-${contentId}-content`).classList.remove('hidden');
            document.querySelectorAll('.bottom-nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.bottom-nav-item[onclick="showStudentContent('${contentId}')"]`).classList.add('active');
        }
        window.showStudentContent = showStudentContent;
        const notificationModal = document.getElementById('notification-modal');
        document.getElementById('notification-bell').addEventListener('click', () => { /* ... */ });
        document.getElementById('close-notification-modal').addEventListener('click', () => notificationModal.classList.add('hidden'));
        document.querySelector('.modal-backdrop').addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
        });
        function showCustomAlert(message, isError = false) { /* ... */ }

    </script>
</body>
</html>
